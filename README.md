# IPFS Gateway ACL

>This code is still a prototype! 
>1. not properly tested or audited
>2. Origin_filter does not make sense with direct because it will never have a referer or origin...
>3. IPNS speed reduced when using dnslink

## Requirements

- Linux OS (tested on Arch)
- Nginx with Lua Support (tested with OpenResty)
- IPFS (tested with Kubo)
- bash, jq, rsync, cron, curl, grep, sed

## Policies (config/default.json)

This ACL implements different policies. Each type of policy can be enabled or disabled. If the request violates one of the policies the status code 403 is returned. The following policies are available (in order of checking):

1. pinset_filter
  - Filter requests that are pinned on host
  - *optional=false:* requires request to be pinned, otherwise 403 will be returned; can be combined with overwrites.
  - *optional=true:* request has not to be pinned, but pinned requested cid can overwrite other policies; therefore it only makes sense in combination with at least one of the overwrites
  - *overwrite:* use to overwrite other policies; so that if pinset contains requested pin the desired policy will not be valuated.
2. origin_filter: 
  - valid hostnames for specific types of request (use lua match expression)
  - *direct:* user-originated request (no origin) (f.E. entering address in address bar)
  - *same_origin:* same-origin request (f.E. navigating on webpage)
  - *user_initiated_top_level:* user initiated top level cross-site request (f.E. clicking a link on an external page)
  - *cross_site:* other cross-site request
3. cid_blocklist: 
  - list of cid to be blocked (generated by `scripts/update-cid-blocklist.sh`)
  - *local / remote / both:* load blocklist from local file (generated by `scripts/block-cid.sh`), badbits (by ipfs) or both.

## Implementation (untested)

>Follow this information to implement IPFS Gateway ACL to existing Gateway.

0. Prerequirements

>Make sure you use nginx with support for LUA filter. Easiest (for Arch-Linux) is to use Openresty as proxy (see [Development Environment](#development-environment)). As an alternative you can use a lua-module for nginx. For example in debian based distros:

```bash
apt install libnginx-mod-http-lua
echo "load_module modules/ngx_http_lua_module.so;"  > /etc/nginx/modules-enabled/50-mod-http-lua.conf
sudo systemctl restart nginx
```

1. Clone Repo to /usr/share/IPFS-Gateway-ACL

```bash
cd /usr/share
git clone https://github.com/chixodo-xyz/ipfs-gateway-acl.git
cd IPFS-Gateway-ACL
```

2. Install LUA dependencies

```bash
sudo cp helpers/lib/*.lua /opt/openresty/site/lualib/

# Alternative for nginx with lua-module:
# sudo mkdir -p /usr/share/lua/5.1/
# sudo helpers/lib/*.lua /usr/share/lua/5.1/
```


3. include nginx.conf to nginx virtual host (section server)

```bash
sudo nano /opt/openresty/nginx/conf/nginx.conf
#ADD to every server section:>
  include /usr/share/ipfs-gateway-acl/nginx.conf;

# Alternative for nginx with lua-module:
# nano /etc/nginx/sites-available/[ipfs-host-config].conf
# #ADD to every server section:>
#  include /usr/share/IPFS-Gateway-ACL/nginx.conf;
```

4. Generate denylist by dwebops 

```bash
bash scripts/update-denylist.sh
#for Testing: 
bash scripts/deny-cid.sh QmcniBv7UQ4gGPQQW2BwbD4ZZHzN3o3tPuNLZCbBchd1zh
bash scripts/update-denylist.sh
```

>Remember to remove customdeny after testing: `rm customdeny.txt ; ./update-denylist.sh`

5. Activate change

```bash
nginx -t
service nginx restart
```

6. Setup Cron to Update denylist
```bash
crontab -e
ADD:>
*/20 * * * * cd /usr/share/ipfs-denylist && ./update-denylist.sh
```


## Development Environment

>Follow this steps to setup local development environment on arch based linux.
>We compile kubo manually that we can install go plugins and such if needed.

1. Setup IPFS Dev Service

```bash
mkdir .dev-environment && cd "$_"
git clone https://github.com/ipfs/kubo && cd kubo
git fetch â€“all
git checkout release #optional to specify which version of kubo should be tested
make build
cp cmd/ipfs/ipfs ../ipfs
cd ../..

export IPFS_PATH=$(pwd)/.dev-environment/ipfs-repo
.dev-environment/ipfs init
.dev-environment/ipfs bootstrap rm --all
.dev-environment/ipfs bootstrap add /ip4/185.143.45.58/tcp/4001/p2p/12D3KooWPE1U1x31QteygQ7a34tzqx5FFJ3B5ttrfWjAqTn8kHo1
.dev-environment/ipfs bootstrap add /ip4/195.15.245.11/tcp/4001/p2p/12D3KooWRHKJzo1ajNGBJnjeaunXXL9jNkEwsEi32KHMQkS5pm3t
.dev-environment/ipfs swarm connect /dnsaddr/chixodo.xyz

.dev-environment/ipfs config --json Gateway.PublicGateways '{"localhost": {"UseSubdomains": true,"InlineDNSLink": true,"Paths": ["/ipfs","/ipns"]}}'
.dev-environment/ipfs config --json API.HTTPHeaders.Access-Control-Allow-Methods '["PUT","POST"]'
.dev-environment/ipfs config --json API.HTTPHeaders.Access-Control-Allow-Origin '["http://localhost:5001","https://webui.ipfs.io"]'
.dev-environment/ipfs config --json Swarm.ConnMgr '{"Type": "basic","LowWater": 10,"HighWater": 30,"GracePeriod": "20s"}'
.dev-environment/ipfs config --json Swarm.AddrFilters "$(cat 'helpers/addrfilters.json')" #use only chixodo for swarm

sed -e "s|<user>|$(whoami)|g" -e "s|<repo>|$(pwd)|g" helpers/ipfs-dev.service > .dev-environment/ipfs-dev.service
sudo cp .dev-environment/ipfs-dev.service /lib/systemd/system/ipfs-dev.service
sudo systemctl daemon-reload
sudo systemctl start ipfs-dev
sudo systemctl status ipfs-dev

#Open in Browser: http://localhost:8080/ipfs/QmcniBv7UQ4gGPQQW2BwbD4ZZHzN3o3tPuNLZCbBchd1zh
#Open in Browser: http://127.0.0.1:5001/webui
```

2. Setup Openresty

```bash
cd .dev-environment
git clone https://aur.archlinux.org/yay-git.git && cd yay-git
makepkg -si
cd ../..

yay -S openresty

sudo cp helpers/lib/*.lua /opt/openresty/site/lualib/

sudo cp /opt/openresty/nginx/conf/nginx.conf /opt/openresty/nginx/conf/nginx.conf.backup
openssl req -new -newkey rsa:2048 -days 3650 -nodes -x509 -subj '/CN=IPFS-Gateway-ACL' -keyout .dev-environment/ssl-fallback.key -out .dev-environment/ssl-fallback.crt 
sed -e "s|<user>|$(whoami)|g" -e "s|<repo>|$(pwd)|g" helpers/nginx-dev.conf > .dev-environment/nginx-dev.conf
sudo cp .dev-environment/nginx-dev.conf /opt/openresty/nginx/conf/nginx.conf

sudo systemctl daemon-reload
sudo systemctl start openresty
sudo systemctl status openresty

#Open in Browser: http://localhost/ipfs/QmcniBv7UQ4gGPQQW2BwbD4ZZHzN3o3tPuNLZCbBchd1zh
#Open in Browser: http://localhost/ipfs/QmeomffUNfmQy76CQGy9NdmqEnnHU9soCexBnGU3ezPHVH
```

3. One last thing: verify if start and stop scripts are working and use this from now on

```bash
sudo bash scripts/stop-dev.sh
sudo bash scripts/start-dev.sh
sudo bash scripts/restart-dev.sh
```


## Credits:

- CID/Multicode/Multihash Implementation: https://github.com/filecoin-project/lua-filecoin
- SHA2 Implementation: https://github.com/Egor-Skriptunoff/pure_lua_SHA
- JSON Implementation: https://github.com/rxi/json.lua
- Tiny Logging Module: https://github.com/rxi/log.lua